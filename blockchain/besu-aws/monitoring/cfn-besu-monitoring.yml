---
AWSTemplateFormatVersion: "2010-09-09"

Description: "Besu Monitoring Template"

Mappings:

  AMIRegionMap:
    us-east-1:
      "HVM64": "ami-00068cd7555f543d5"
    us-east-2:
      "HVM64": "ami-0dacb0c129b49f529"
    us-west-1:
      "HVM64": "ami-0b2d8d1abb76a53d8"
    us-west-2:
      "HVM64": "ami-0c5204531f799e0c6"
    ap-south-1:
      "HVM64": "ami-0ce933e2ae91880d3"
    ap-southeast-1:
      "HVM64": "ami-07539a31f72d244e7"
    ap-southeast-2:
      "HVM64": "ami-0119aa4d67e59007c"
    ap-northeast-1:
      "HVM64": "ami-068a6cefc24c301d2"
    ap-northeast-2:
      "HVM64": "ami-0d59ddf55cdda6e21"
    ca-central-1:
      "HVM64": "ami-0ff24797826ebbcd5"
    sa-east-1:
      "HVM64": "ami-07820a4443539a2b0"
    eu-central-1:
      "HVM64": "ami-0d4c3eabb9e72650a"
    eu-west-1:
      "HVM64": "ami-01f14919ba412de34"
    eu-west-2:
      "HVM64": "ami-05f37c3995fffb4fd"
    eu-west-3:
      "HVM64": "ami-0e9e6ba6d3d38faa8"
    eu-north-1:
      "HVM64": "ami-006cda581cf39451b"

Parameters:

  VpcId:
    Description: The Vpc ID to deploy the instance into
    Type: String

  SubnetId:
    Description: The Subnet ID of the VPC to deploy the instance into, generally this is in a public subnet
    Type: String

  PublicCidrRange:
    Default: 0.0.0.0/0
    Description: The CIDR range or IP that is allowed to access the monitoring instance
    Type: String

  Ec2InstanceType:
    AllowedValues:
      - t2.small
      - t2.medium
      - t3.small
      - t3.medium
    Default: t3.small
    Description: The EC2 instance type
    Type: String

  Ec2KeyPair:
    Description: The ssh key pair to use with the EC2 instance
    Type: String

  BesuNodesNamePrefix:
    Default: besu-.*
    Description: The prefix to match the besu node instance names
    Type: String

  GrafanaPassword:
    Default: Password1
    Description: The password to use for the Grafana Dashboard
    Type: String

Resources:

  PublicSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Public Security Group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: '-1'
      SecurityGroupIngress:
        - CidrIp: !Ref PublicCidrRange
          FromPort: 3000
          ToPort: 3000
          IpProtocol: tcp
        - CidrIp: !Ref PublicCidrRange
          FromPort: 9090
          ToPort: 9090
          IpProtocol: tcp
        - CidrIp: !Ref PublicCidrRange
          FromPort: 22
          IpProtocol: tcp
          ToPort: 22
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-sg-public"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - Ref: EC2Role

  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess"

  EC2Instance:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT5M
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          default:
            - cfn-hup
            - data-volume-init
            - data-volume-setup
            - bootstrap
        cfn-hup:
          files:
            /etc/cfn/cfn-hup.conf:
              content:
                !Sub |
                [main]
                stack=${AWS::StackId}
                region=${AWS::Region}
                interval=1
              group: root
              mode: "000400"
              owner: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content:
                !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.ConsulLaunchConfiguration.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource EC2Instance --region ${AWS::Region}
                runas=root
            /lib/systemd/system/cfn-hup.service:
              content: !Sub |
                [Unit]
                Description=cfn-hup daemon
                [Service]
                Type=simple
                ExecStart=/opt/aws/bin/cfn-hup
                Restart=always
                [Install]
                WantedBy=multi-user.target
              mode: "000400"
              owner: root
              group: root
          commands:
            01_enable_cfn-hup:
              command: "systemctl enable cfn-hup.service"
            02_start_cfn-hup:
              command: "systemctl start cfn-hup.service"
        data-volume-init:
          commands:
            01_data-volume-filesystem:
              command: |
                #!/bin/bash
                device=$(lsblk | grep 100G | grep -o "^\w*\b")
                # check that it doesnt have a fs before wiping i.e if its healing and recovers with an existing volume leave it as is
                fs_check=$(file -s /dev/$device)
                if [[ $fs_check == *"ext4 filesystem"* ]]; then
                  echo "Existing filesystem... "
                else
                  echo "No filesystem found, creating one..."
                  mkfs.ext4 /dev/$device && e2fsck -f /dev/$device && resize2fs /dev/$device
                fi
                mkdir /data && chown -R ec2-user:ec2-user /data
                UUID=$(blkid /dev/$device | grep -oP '(UUID=).*(?=TYPE)' | sed -e 's/"//g')
                echo "$UUID      /data   ext4    defaults,nofail  0  2" >> /etc/fstab
                mount -a
                mkdir -p /data/prometheus/data && mkdir -p /data/prometheus/config
                mkdir -p /data/grafana/data && mkdir -p /data/grafana/config/provisioning/datasources && mkdir -p /data/grafana/config/provisioning/dashboards
                chown -R ec2-user:ec2-user /data && chmod -R 777 /data
                # 472 is the respective container user:group pair
                mkdir -p /var/log/grafana/ && sudo chown -R 472:472 /var/log/grafana/
              cwd: /
        data-volume-setup:
          files:
            /etc/logrotate.d/grafana:
              content:
                !Sub |
                ---
                /var/log/grafana/*.log {
                    rotate 7
                    missingok
                    daily
                    compress
                    copytruncate
                }
              owner: root
              group: root
              mode: '000644'
            /data/grafana/config/provisioning/datasources/prometheus.yml:
              content:
                !Sub |
                ---
                apiVersion: 1
                deleteDatasources:
                  - name: Graphite
                    orgId: 1
                datasources:
                  - name: Prometheus
                    type: prometheus
                    access: proxy
                    orgId: 1
                    url: http://localhost:9090
                    password:
                    user:
                    database:
                    basicAuth:
                    basicAuthUser:
                    basicAuthPassword:
                    withCredentials:
                    isDefault: true
                    jsonData:
                      graphiteVersion: "1.1"
                      tlsAuth: false
                      tlsAuthWithCACert: false
                    secureJsonData:
                      tlsCACert: "..."
                      tlsClientCert: "..."
                      tlsClientKey: "..."
                      password:
                      basicAuthPassword:
                    version: 1
                    editable: true
              owner: ec2-user
              group: ec2-user
              mode: '000644'
            /data/grafana/config/provisioning/dashboards/dashboard.yml:
              content:
                !Sub |
                ---
                apiVersion: 1
                providers:
                  - name: 'Prometheus'
                    orgId: 1
                    folder: ''
                    type: file
                    disableDeletion: false
                    editable: true
                    options:
                      path: /etc/grafana/provisioning/dashboards
              owner: ec2-user
              group: ec2-user
              mode: '000644'
            /data/grafana/config/provisioning/dashboards/besu.json:
              content:
                !Sub |
                {
                  "__inputs": [
                    {
                      "name": "Prometheus",
                      "label": "Prometheus",
                      "description": "",
                      "type": "datasource",
                      "pluginId": "prometheus",
                      "pluginName": "Prometheus"
                    }
                  ],
                  "__requires": [
                    {
                      "type": "grafana",
                      "id": "grafana",
                      "name": "Grafana",
                      "version": "6.2.4"
                    },
                    {
                      "type": "panel",
                      "id": "graph",
                      "name": "Graph",
                      "version": ""
                    },
                    {
                      "type": "datasource",
                      "id": "prometheus",
                      "name": "Prometheus",
                      "version": "1.0.0"
                    },
                    {
                      "type": "panel",
                      "id": "table",
                      "name": "Table",
                      "version": ""
                    }
                  ],
                  "annotations": {
                    "list": [
                      {
                        "builtIn": 1,
                        "datasource": "-- Grafana --",
                        "enable": true,
                        "hide": true,
                        "iconColor": "rgba(0, 211, 255, 1)",
                        "name": "Annotations & Alerts",
                        "type": "dashboard"
                      }
                    ]
                  },
                  "description": "Provides an overview of Besu nodes",
                  "editable": true,
                  "gnetId": 10273,
                  "graphTooltip": 0,
                  "id": null,
                  "iteration": 1563430575313,
                  "links": [],
                  "panels": [
                    {
                      "columns": [],
                      "fontSize": "120%",
                      "gridPos": {
                        "h": 9,
                        "w": 24,
                        "x": 0,
                        "y": 0
                      },
                      "id": 10,
                      "links": [],
                      "options": {},
                      "pageSize": null,
                      "scroll": true,
                      "showHeader": true,
                      "sort": {
                        "col": 2,
                        "desc": true
                      },
                      "styles": [
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "job",
                          "thresholds": [],
                          "type": "hidden",
                          "unit": "short"
                        },
                        {
                          "alias": "Chain Height",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #A",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Total Difficulty",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #B",
                          "thresholds": [],
                          "type": "number",
                          "unit": "sci"
                        },
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Time",
                          "thresholds": [],
                          "type": "hidden",
                          "unit": "short"
                        },
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "__name__",
                          "thresholds": [],
                          "type": "hidden",
                          "unit": "short"
                        },
                        {
                          "alias": "Peer Count",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #C",
                          "thresholds": [
                            ""
                          ],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Block Time (5m avg)",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #D",
                          "thresholds": [],
                          "type": "number",
                          "unit": "s"
                        },
                        {
                          "alias": "System",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "instance",
                          "thresholds": [],
                          "type": "string",
                          "unit": "short",
                          "valueMaps": []
                        },
                        {
                          "alias": "Time Since Last Block",
                          "colorMode": "value",
                          "colors": [
                            "rgba(50, 172, 45, 0.97)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(245, 54, 54, 0.9)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #E",
                          "thresholds": [
                            "120",
                            "240"
                          ],
                          "type": "number",
                          "unit": "dtdurations"
                        },
                        {
                          "alias": "Target Chain Height",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #F",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Blocks Behind",
                          "colorMode": "value",
                          "colors": [
                            "rgba(50, 172, 45, 0.97)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(245, 54, 54, 0.9)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #G",
                          "thresholds": [
                            "1",
                            "10"
                          ],
                          "type": "number",
                          "unit": "locale",
                          "valueMaps": [
                            {
                              "text": "Yes",
                              "value": "1"
                            },
                            {
                              "text": "No",
                              "value": "0"
                            }
                          ]
                        },
                        {
                          "alias": "% Peer Limit Used",
                          "colorMode": "value",
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #H",
                          "thresholds": [
                            "0.25",
                            "0.75"
                          ],
                          "type": "number",
                          "unit": "percentunit"
                        },
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "decimals": 2,
                          "pattern": "/.*/",
                          "thresholds": [],
                          "type": "number",
                          "unit": "short"
                        }
                      ],
                      "targets": [
                        {
                          "expr": "sum by (instance) (besu_blockchain_height{instance=~\"$system\"} or ethereum_blockchain_height{instance=~\"$system\"})",
                          "format": "table",
                          "instant": true,
                          "interval": "",
                          "intervalFactor": 1,
                          "legendFormat": "Chain Height",
                          "refId": "A"
                        },
                        {
                          "expr": "sum by (instance) (besu_synchronizer_best_known_block{instance=~\"$system\"} or ethereum_best_known_block_number{instance=~\"$system\"})",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "F"
                        },
                        {
                          "expr": "sum by (instance) ((besu_synchronizer_best_known_block{instance=~\"$system\"} - besu_blockchain_height{instance=~\"$system\"}) or (ethereum_best_known_block_number{instance=~\"$system\"} - ethereum_blockchain_height{instance=~\"$system\"}))",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "G"
                        },
                        {
                          "expr": "sum by (instance) (besu_blockchain_difficulty_total{instance=~\"$system\"})",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "legendFormat": "Total Difficulty",
                          "refId": "B"
                        },
                        {
                          "expr": "sum by (instance) ((1/rate(besu_blockchain_height{instance=~\"$system\"}[5m])) or (1/rate(ethereum_blockchain_height{instance=~\"$system\"}[5m])))",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "D"
                        },
                        {
                          "expr": "sum by (instance) (time() - besu_blockchain_chain_head_timestamp{instance=~\"$system\"})",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "E"
                        },
                        {
                          "expr": "sum by (instance) (besu_peers_peer_count_current{instance=~\"$system\"} or ethereum_peer_count{instance=~\"$system\"})",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "legendFormat": "Peer Count",
                          "refId": "C"
                        },
                        {
                          "expr": "sum by (instance) ((besu_peers_peer_count_current{instance=~\"$system\"} / besu_network_peers_limit{instance=~\"$system\"}) or ethereum_peer_count{instance=~\"$system\"} / ethereum_peer_limit{instance=~\"$system\"})",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "H"
                        }
                      ],
                      "title": "Overview",
                      "transform": "table",
                      "type": "table"
                    },
                    {
                      "columns": [],
                      "fontSize": "100%",
                      "gridPos": {
                        "h": 9,
                        "w": 24,
                        "x": 0,
                        "y": 9
                      },
                      "id": 15,
                      "links": [],
                      "options": {},
                      "pageSize": null,
                      "scroll": true,
                      "showHeader": true,
                      "sort": {
                        "col": 2,
                        "desc": true
                      },
                      "styles": [
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "job",
                          "thresholds": [],
                          "type": "hidden",
                          "unit": "short"
                        },
                        {
                          "alias": "Chain Height",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #A",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Pivot Block Number",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #B",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Time",
                          "thresholds": [],
                          "type": "hidden",
                          "unit": "short"
                        },
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "__name__",
                          "thresholds": [],
                          "type": "hidden",
                          "unit": "short"
                        },
                        {
                          "alias": "Pending State Nodes",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #C",
                          "thresholds": [
                            ""
                          ],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Downloaded State Nodes",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #D",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "System",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "instance",
                          "thresholds": [],
                          "type": "string",
                          "unit": "short",
                          "valueMaps": []
                        },
                        {
                          "alias": "Blocks To Download",
                          "colorMode": null,
                          "colors": [
                            "rgba(50, 172, 45, 0.97)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(245, 54, 54, 0.9)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #E",
                          "thresholds": [
                            "0",
                            "0"
                          ],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Target Chain Height",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #F",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Blocks Behind",
                          "colorMode": "value",
                          "colors": [
                            "rgba(50, 172, 45, 0.97)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(245, 54, 54, 0.9)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 2,
                          "mappingType": 1,
                          "pattern": "Value #G",
                          "thresholds": [
                            "1",
                            "10"
                          ],
                          "type": "number",
                          "unit": "locale",
                          "valueMaps": [
                            {
                              "text": "Yes",
                              "value": "1"
                            },
                            {
                              "text": "No",
                              "value": "0"
                            }
                          ]
                        },
                        {
                          "alias": "% Peer Limit Used",
                          "colorMode": "value",
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #H",
                          "thresholds": [
                            "0.25",
                            "0.75"
                          ],
                          "type": "number",
                          "unit": "percentunit"
                        },
                        {
                          "alias": "Pending State Nodes",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #I",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "Downloaded State Nodes",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "dateFormat": "YYYY-MM-DD HH:mm:ss",
                          "decimals": 0,
                          "mappingType": 1,
                          "pattern": "Value #J",
                          "thresholds": [],
                          "type": "number",
                          "unit": "locale"
                        },
                        {
                          "alias": "",
                          "colorMode": null,
                          "colors": [
                            "rgba(245, 54, 54, 0.9)",
                            "rgba(237, 129, 40, 0.89)",
                            "rgba(50, 172, 45, 0.97)"
                          ],
                          "decimals": 2,
                          "pattern": "/.*/",
                          "thresholds": [],
                          "type": "number",
                          "unit": "short"
                        }
                      ],
                      "targets": [
                        {
                          "expr": "sum by (instance) ((besu_blockchain_height{instance=~\"$system\"} or ethereum_blockchain_height{instance=~\"$system\"}) and besu_synchronizer_world_state_pending_requests_current{instance=~\"$system\"} > 0)",
                          "format": "table",
                          "instant": true,
                          "interval": "",
                          "intervalFactor": 1,
                          "legendFormat": "Chain Height",
                          "refId": "A"
                        },
                        {
                          "expr": "sum by (instance) (besu_synchronizer_fast_sync_pivot_block_current{instance=~\"$system\"} and besu_synchronizer_world_state_pending_requests_current{instance=~\"$system\"} > 0)",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "B"
                        },
                        {
                          "expr": "sum by (instance) (besu_synchronizer_fast_sync_pivot_block_current{instance=~\"$system\"} - besu_blockchain_height{instance=~\"$system\"} and besu_synchronizer_world_state_pending_requests_current{instance=~\"$system\"} > 0)",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "E"
                        },
                        {
                          "expr": "sum by (instance) (besu_synchronizer_world_state_pending_requests_current{instance=~\"$system\"} > 0)",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "C"
                        },
                        {
                          "expr": "sum by (instance) (besu_synchronizer_world_state_completed_requests_total{instance=~\"$system\"} and besu_synchronizer_world_state_pending_requests_current{instance=~\"$system\"} > 0)",
                          "format": "table",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "D"
                        }
                      ],
                      "title": "Fast Sync Progress",
                      "transform": "table",
                      "type": "table"
                    },
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "fill": 1,
                      "gridPos": {
                        "h": 14,
                        "w": 12,
                        "x": 0,
                        "y": 18
                      },
                      "id": 12,
                      "legend": {
                        "alignAsTable": true,
                        "avg": true,
                        "current": true,
                        "max": true,
                        "min": true,
                        "rightSide": false,
                        "show": true,
                        "total": false,
                        "values": true
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "options": {},
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "1/rate(besu_blockchain_height{instance=~\"$system\"}[5m]) or 1/rate(ethereum_blockchain_height{instance=~\"$system\"}[5m])",
                          "format": "time_series",
                          "interval": "",
                          "intervalFactor": 1,
                          "legendFormat": "{{instance}}",
                          "refId": "A"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeRegions": [],
                      "timeShift": null,
                      "title": "Block Time",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "s",
                          "label": null,
                          "logBase": 10,
                          "max": null,
                          "min": null,
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ],
                      "yaxis": {
                        "align": false,
                        "alignLevel": null
                      }
                    },
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "fill": 1,
                      "gridPos": {
                        "h": 14,
                        "w": 12,
                        "x": 12,
                        "y": 18
                      },
                      "id": 13,
                      "legend": {
                        "alignAsTable": true,
                        "avg": true,
                        "current": true,
                        "max": true,
                        "min": true,
                        "rightSide": false,
                        "show": true,
                        "total": false,
                        "values": true
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "options": {},
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "besu_synchronizer_best_known_block{instance=~\"$system\"} - besu_blockchain_height{instance=~\"$system\"} or ethereum_best_known_block_number{instance=~\"$system\"} - ethereum_blockchain_height{instance=~\"$system\"}",
                          "format": "time_series",
                          "interval": "",
                          "intervalFactor": 1,
                          "legendFormat": "{{instance}}",
                          "refId": "A"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeRegions": [],
                      "timeShift": null,
                      "title": "Blocks Behind",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "locale",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ],
                      "yaxis": {
                        "align": false,
                        "alignLevel": null
                      }
                    },
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "fill": 1,
                      "gridPos": {
                        "h": 12,
                        "w": 24,
                        "x": 0,
                        "y": 32
                      },
                      "id": 6,
                      "legend": {
                        "avg": false,
                        "current": false,
                        "max": false,
                        "min": false,
                        "show": true,
                        "total": false,
                        "values": false
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "options": {},
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "irate(process_cpu_seconds_total{instance=~\"$system\"}[1m])",
                          "format": "time_series",
                          "intervalFactor": 1,
                          "legendFormat": "CPU Time IRate [{{instance}}]",
                          "refId": "A"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeRegions": [],
                      "timeShift": null,
                      "title": "CPU",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ],
                      "yaxis": {
                        "align": false,
                        "alignLevel": null
                      }
                    },
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "datasource": "Prometheus",
                      "fill": 1,
                      "gridPos": {
                        "h": 12,
                        "w": 12,
                        "x": 0,
                        "y": 44
                      },
                      "id": 8,
                      "legend": {
                        "avg": false,
                        "current": false,
                        "max": false,
                        "min": false,
                        "show": true,
                        "total": false,
                        "values": false
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "options": {},
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "rate(jvm_gc_collection_seconds_sum{instance=~\"$system\"}[1m])",
                          "format": "time_series",
                          "interval": "",
                          "intervalFactor": 5,
                          "legendFormat": "{{gc}} [{{instance}}]",
                          "metric": "jvm_gc_collection_seconds_sum",
                          "refId": "A",
                          "step": 10
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeRegions": [],
                      "timeShift": null,
                      "title": "GC time",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "decimals": null,
                          "format": "percentunit",
                          "label": null,
                          "logBase": 1,
                          "max": "1",
                          "min": "0",
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ],
                      "yaxis": {
                        "align": false,
                        "alignLevel": null
                      }
                    },
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "fill": 1,
                      "gridPos": {
                        "h": 12,
                        "w": 12,
                        "x": 12,
                        "y": 44
                      },
                      "id": 4,
                      "legend": {
                        "alignAsTable": true,
                        "avg": true,
                        "current": true,
                        "max": true,
                        "min": true,
                        "show": true,
                        "total": false,
                        "values": true
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "options": {},
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "jvm_memory_bytes_used{instance=~\"$system\", area=\"heap\"} + ignoring(area) jvm_memory_bytes_used{instance=~\"$system\", area=\"nonheap\"}",
                          "format": "time_series",
                          "intervalFactor": 5,
                          "legendFormat": "{{instance}}",
                          "refId": "A"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeRegions": [],
                      "timeShift": null,
                      "title": "Memory Used",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "decbytes",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ],
                      "yaxis": {
                        "align": false,
                        "alignLevel": null
                      }
                    }
                  ],
                  "refresh": "10s",
                  "schemaVersion": 18,
                  "style": "dark",
                  "tags": [
                    "besu",
                    "ethereum"
                  ],
                  "templating": {
                    "list": [
                      {
                        "allValue": null,
                        "current": {},
                        "datasource": "Prometheus",
                        "definition": "query_result(ethereum_blockchain_height or besu_blockchain_height)",
                        "hide": 0,
                        "includeAll": true,
                        "label": "System",
                        "multi": true,
                        "name": "system",
                        "options": [],
                        "query": "query_result(ethereum_blockchain_height or besu_blockchain_height)",
                        "refresh": 2,
                        "regex": "/instance=\"([^\"]*)\"/",
                        "skipUrlSync": false,
                        "sort": 5,
                        "tagValuesQuery": "",
                        "tags": [],
                        "tagsQuery": "",
                        "type": "query",
                        "useTags": false
                      }
                    ]
                  },
                  "time": {
                    "from": "now-12h",
                    "to": "now"
                  },
                  "timepicker": {
                    "refresh_intervals": [
                      "5s",
                      "10s",
                      "30s",
                      "1m",
                      "5m",
                      "15m",
                      "30m",
                      "1h",
                      "2h",
                      "1d"
                    ],
                    "time_options": [
                      "5m",
                      "15m",
                      "1h",
                      "6h",
                      "12h",
                      "24h",
                      "2d",
                      "7d",
                      "30d"
                    ]
                  },
                  "timezone": "",
                  "title": "Besu Overview",
                  "uid": "5S-6O8VZk",
                  "version": 4
                }
              owner: ec2-user
              group: ec2-user
              mode: '000644'
            /data/prometheus/config/prometheus.yml:
              content: !Sub
                - |
                  ---
                  global:
                    scrape_interval:     15s
                    evaluation_interval: 15s
                  alerting:
                  rule_files:
                  scrape_configs:
                    - job_name: prometheus
                      scrape_interval: 15s
                      scrape_timeout: 10s
                      metrics_path: /metrics
                      scheme: http
                      static_configs:
                        - targets: [ localhost:9090 ]
                    - job_name: besu-nodes
                      scrape_interval: 15s
                      scrape_timeout: 10s
                      metrics_path: /metrics
                      scheme: http
                      ec2_sd_configs:
                        - region: ${AWS::Region}
                          port: 9545
                      relabel_configs:
                        - source_labels: [__meta_ec2_tag_Name]
                          regex: ${besuNodesNamePrefix}
                          action: keep
                        - source_labels: [__meta_ec2_tag_Name]
                          target_label: instance
                - besuNodesNamePrefix:
                    !Ref BesuNodesNamePrefix
              owner: ec2-user
              group: ec2-user
              mode: '000644'
            /data/docker-compose.yml:
              content: !Sub
                - |
                  ---
                  version: "3.4"

                  services:
                    prometheus:
                      container_name: prometheus
                      labels:
                        service_name: prometheus
                      image: "registry.hub.docker.com/prom/prometheus:v2.10.0"
                      restart: always
                      network_mode: "host"
                      ports:
                        - "9090:9090"
                      volumes:
                        - /var/run/docker.sock:/var/run/docker.sock:ro
                        - /data/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml
                        - /data/prometheus/data/:/prometheus
                      command:
                        - '--log.format=json'
                        - '--config.file=/etc/prometheus/prometheus.yml'
                      logging:
                        driver: "json-file"
                        options:
                          max-size: "200k"
                          max-file: "10"
                      environment:
                        AWS_REGION: ${AWS::Region}
                      deploy:
                        resources:
                          limits:
                            cpus: '0.50'
                            memory: 1024M
                          reservations:
                            cpus: '0.25'
                            memory: 512M                        
                      cap_add:
                        - NET_ADMIN

                    grafana:
                      container_name: grafana
                      labels:
                        service_name: grafana
                      image: "registry.hub.docker.com/grafana/grafana:6.2.4"
                      restart: always
                      network_mode: "host"
                      ports:
                        - "3000:3000"
                      volumes:
                        - /data/grafana/config/provisioning/:/etc/grafana/provisioning/
                        - /data/grafana/data/:/var/lib/grafana/
                        - /var/run/docker.sock:/var/run/docker.sock:ro
                        - /var/log/grafana/:/var/log/grafana/
                      environment:
                        AWS_REGION: ${AWS::Region}
                        GF_SECURITY_ADMIN_PASSWORD: "${grafanaPassword}"
                        GF_LOG_MODE: "file"
                      deploy:
                        resources:
                          limits:
                            cpus: '0.50'
                            memory: 1024M
                          reservations:
                            cpus: '0.25'
                            memory: 512M
                      cap_add:
                        - NET_ADMIN
                - grafanaPassword:
                    !Ref GrafanaPassword
              owner: ec2-user
              group: ec2-user
              mode: '000644'
        bootstrap:
          commands:
            01_bootstrap-monitoring:
              command: |
                #!/bin/bash
                docker-compose up -d
              cwd: /data
    Properties:
      ImageId: !FindInMap [ AMIRegionMap, !Ref 'AWS::Region' , HVM64 ]
      KeyName: !Ref Ec2KeyPair
      InstanceType: !Ref Ec2InstanceType
      EbsOptimized: true
      IamInstanceProfile: !Ref EC2InstanceProfile
      SubnetId: !Ref SubnetId
      SecurityGroupIds:
      - !Ref PublicSecurityGroup
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeSize: 20
      - DeviceName: /dev/xvdf
        Ebs:
          VolumeSize: 100
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            yum update -y --security --exclude=kernel*
            yum install -y docker wget curl ntp bind-utils iproute
            usermod -a -G docker ec2-user
            systemctl restart docker
            # install compose
            curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource EC2Instance --configsets default --region ${AWS::Region}
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource EC2Instance --region ${AWS::Region}
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-besu-monitoring"

Outputs:
  EC2InstanceID:
    Description: The Instance ID
    Value: !Ref EC2Instance

  EC2InstancePublicIp:
    Description: The Instance PublicIp
    Value: !GetAtt EC2Instance.PublicIp

  EC2InstancePublicDnsName:
    Description: The Instance PublicDnsName
    Value: !GetAtt EC2Instance.PublicDnsName
